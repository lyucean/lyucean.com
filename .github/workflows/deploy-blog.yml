name: Deployment Blog

concurrency: production

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ä–µ–¥—É "production"

    steps:
      - name: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
        uses: actions/checkout@v4

      - name: "–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—ã"
        run: |
          echo "WORDPRESS_DB_NAME=${{ secrets.WORDPRESS_DB_NAME }}" >> .env
          echo "WORDPRESS_DB_USER=${{ secrets.WORDPRESS_DB_USER }}" >> .env
          echo "WORDPRESS_DB_PASSWORD=${{ secrets.WORDPRESS_DB_PASSWORD }}" >> .env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env
          
          echo "ENVIRONMENT=${{ vars.ENVIRONMENT }}" >> .env
          echo "WORDPRESS_DEBUG=${{ vars.WORDPRESS_DEBUG }}" >> .env
          echo "BACKUPS_FOLDER=${{ vars.BACKUPS_FOLDER }}" >> .env

      - name: "–°–æ–∑–¥–∞–¥–∏–º –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–µ–∫—Ç–∞"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: mkdir -p /home/user/lyucean.com

      - name: "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ .env –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞."
        run: mv .env ./app || ls ./app

      - name: "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä."
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: "./*"
          target: "/var/www/lyucean.com"

  publish:
    name: "–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
    runs-on: ubuntu-latest
    needs: [deploy]
    environment: production  # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ä–µ–¥—É "production"
    steps:
      - name: "–°–æ–∑–¥–∞–¥–∏–º –≤–µ–±-—Å–µ—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ docker compose."
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            set -e  # –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."
            echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º —Å–µ—Ç—å Docker..."
            docker network ls | grep web || docker network create web
            cd /var/www/lyucean.com/
            echo "üîê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
            chown -R www-data:www-data ./app/wordpress ./app/my_plugins ./app/my_themes
            find ./app/wordpress ./app/my_plugins ./app/my_themes -type d -exec chmod 755 {} \;
            find ./app/wordpress ./app/my_plugins ./app/my_themes -type f -exec chmod 644 {} \;
            echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
            make update
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker compose ps || exit 1

  test:
    name: "–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –Ω–∞—à –±–ª–æ–≥ –∑–∞–ø—É—â–µ–Ω"
    runs-on: ubuntu-latest
    needs: [publish]
    steps:
      - name: Check website
        uses: wei/curl@v1
        with:
          args:  https://lyucean.com/

  alert:
    name: Alert
    runs-on: ubuntu-latest
    needs: [publish]
    steps:
      - name: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —á—Ç–æ –≤—Å—ë —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–æ—Å—å"
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ github.actor }} —Å–æ–∑–¥–∞–ª commit:
            Commit: ${{ github.event.commits[0].message }}

            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}

            –ò–∑–º–µ–Ω–µ–Ω–∏—è: https://github.com/${{ github.repository }}/commit/${{github.sha}}